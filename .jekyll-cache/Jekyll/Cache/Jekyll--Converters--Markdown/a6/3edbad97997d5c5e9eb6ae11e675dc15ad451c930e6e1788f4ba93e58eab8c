I"Àc<h3 id="ä¸€-å‡†å¤‡å·¥ä½œ">ä¸€. å‡†å¤‡å·¥ä½œ</h3>

<ul>
  <li>åœ¨Windowsä¸Šæ­å»ºå®ŒæˆTensorflowçš„C++ç¯å¢ƒï¼Œè¿™é‡Œå‚è€ƒæœ¬äººçš„ä¸Šä¸€ç¯‡åšå®¢</li>
  <li>åœ¨windowsä¸Šéƒ¨ç½²opencv3çš„C++ç¯å¢ƒ</li>
  <li>python3çš„keraså’Œtf2.Xçš„ç¯å¢ƒï¼š<code class="language-plaintext highlighter-rouge">pip3 install keras==2.4.3</code>å’Œ<code class="language-plaintext highlighter-rouge">pip3 install tensorflow==2.3.1</code></li>
  <li>python3çš„opencvç¯å¢ƒï¼š<code class="language-plaintext highlighter-rouge">pip3 install opencv-python</code></li>
</ul>

<h3 id="äºŒ-pythonæ¨¡å‹è®­ç»ƒ">äºŒ. pythonæ¨¡å‹è®­ç»ƒ</h3>

<blockquote>
  <p>pythonæ¨¡å‹æ„å»ºï¼š<a href="https://www.kaggle.com/tongpython/cat-and-dog">KaggleçŒ«ç‹—åˆ†ç±»</a></p>

  <p>pythonå®Œæ•´ä»£ç æ”¾åœ¨æœ¬äººçš„<a href="">gitä»“åº“</a>ä¸Šé¢</p>
</blockquote>

<h4 id="21-æ¨¡å‹è®­ç»ƒä¿å­˜h5æ ¼å¼çš„æ¨¡å‹æ–‡ä»¶">2.1 æ¨¡å‹è®­ç»ƒï¼Œä¿å­˜.h5æ ¼å¼çš„æ¨¡å‹æ–‡ä»¶</h4>

<p>åœ¨kerasçš„<code class="language-plaintext highlighter-rouge">model.save()</code>æ¨¡å‹ä¿å­˜çš„å‡½æ•°ä¸­ï¼Œåªæ”¯æŒ2ç§ä¿å­˜æ–¹å¼ï¼š</p>

<ul>
  <li>
    <p>.h5æ ¼å¼çš„æ–‡ä»¶è¿›è¡Œä¿å­˜æ¨¡å‹æ•´ä¸ªç»“æ„åŠå…¶æƒé‡ã€‚</p>
  </li>
  <li>
    <p>ä»¥æ–‡ä»¶å¤¹ï¼ˆåŒ…å«assets  saved_model.pb  variablesï¼‰æ¥ä¿å­˜ï¼Œæ¨¡å‹æ¶æ„å’Œè®­ç»ƒé…ç½®ï¼ˆåŒ…æ‹¬ä¼˜åŒ–å™¨ã€æŸå¤±å’ŒæŒ‡æ ‡ï¼‰å­˜å‚¨åœ¨ <code class="language-plaintext highlighter-rouge">saved_model.pb</code> ä¸­ã€‚æƒé‡ä¿å­˜åœ¨ <code class="language-plaintext highlighter-rouge">variables/</code> ç›®å½•ä¸‹ã€‚</p>
  </li>
</ul>

<p>å› æ­¤ä½¿ç”¨.h5æ ¼å¼æ¥å­˜å‚¨æ¨¡å‹ç»“æ„åŠæƒé‡ã€‚</p>

<h4 id="22-h5æ–‡ä»¶è½¬ptæ–‡ä»¶">2.2 h5æ–‡ä»¶è½¬ptæ–‡ä»¶</h4>

<p>å°†è®­ç»ƒå¥½çš„æ¨¡å‹ä»¥.h5æ ¼å¼è¿›è¡Œå­˜å‚¨ï¼Œå†é€šè¿‡è½¬æˆ.ptæ ¼å¼çš„æ¨¡å‹æ–‡ä»¶ï¼Œæä¾›C++çš„tensorflowè°ƒç”¨æ¨¡å‹ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow.python.keras.backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.framework</span> <span class="kn">import</span> <span class="n">graph_io</span>
<span class="c1"># é’ˆå¯¹tf2.xæ¥è¯´ä¸æ”¯æŒfreezegraphçš„ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨tf1çš„æ–¹å¼
</span><span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">disable_eager_execution</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">freeze_session</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">keep_var_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">clear_devices</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">tensorflow.python.framework.graph_util</span> <span class="kn">import</span> <span class="n">convert_variables_to_constants</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">graph</span>
    <span class="k">with</span> <span class="n">graph</span><span class="p">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="n">freeze_var_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">global_variables</span><span class="p">()).</span><span class="n">difference</span><span class="p">(</span><span class="n">keep_var_names</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="n">output_names</span> <span class="o">=</span> <span class="n">output_names</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">output_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">global_variables</span><span class="p">()]</span>
        <span class="n">input_graph_def</span> <span class="o">=</span> <span class="n">graph</span><span class="p">.</span><span class="n">as_graph_def</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clear_devices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">input_graph_def</span><span class="p">.</span><span class="n">node</span><span class="p">:</span>
                <span class="n">node</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="s">""</span>
        <span class="n">frozen_graph</span> <span class="o">=</span> <span class="n">convert_variables_to_constants</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">input_graph_def</span><span class="p">,</span>
                                                      <span class="n">output_names</span><span class="p">,</span> <span class="n">freeze_var_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frozen_graph</span>


<span class="s">"""----------------------------------é…ç½®è·¯å¾„-----------------------------------"""</span>
<span class="n">h5_model_path</span> <span class="o">=</span> <span class="s">'model/model.h5'</span>
<span class="n">pb_model_name</span> <span class="o">=</span> <span class="s">'model.pt'</span>
<span class="n">output_path</span> <span class="o">=</span> <span class="s">'.'</span>

<span class="s">"""----------------------------------å¯¼å…¥kerasæ¨¡å‹------------------------------"""</span>
<span class="n">K</span><span class="p">.</span><span class="n">set_learning_phase</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">net_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">h5_model_path</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'input is :'</span><span class="p">,</span> <span class="n">net_model</span><span class="p">.</span><span class="nb">input</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'output is:'</span><span class="p">,</span> <span class="n">net_model</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

<span class="s">"""----------------------------------ä¿å­˜ä¸º.pbæ ¼å¼------------------------------"""</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="n">get_session</span><span class="p">()</span>
<span class="n">frozen_graph</span> <span class="o">=</span> <span class="n">freeze_session</span><span class="p">(</span><span class="n">K</span><span class="p">.</span><span class="n">get_session</span><span class="p">(),</span><span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="n">out</span><span class="p">.</span><span class="n">op</span><span class="p">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">net_model</span><span class="p">.</span><span class="n">outputs</span><span class="p">])</span>
<span class="n">graph_io</span><span class="p">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">frozen_graph</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">pb_model_name</span><span class="p">,</span> <span class="n">as_text</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="23-æµ‹è¯•ptæ¨¡å‹æ–‡ä»¶">2.3 æµ‹è¯•ptæ¨¡å‹æ–‡ä»¶</h4>

<p>å¯¹åŒä¸€ä¸ªå›¾ç‰‡åˆ†åˆ«åˆ©ç”¨.h5æ¨¡å‹æ–‡ä»¶å’Œ.ptæ¨¡å‹æ–‡ä»¶è¿›è¡Œé¢„æµ‹ã€‚.ptæ ¼å¼çš„æ¨¡å‹é¢„æµ‹ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">pred_with_pt</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pb_file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">Graph</span><span class="p">().</span><span class="n">as_default</span><span class="p">():</span>
        <span class="n">output_graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">GraphDef</span><span class="p">()</span>

        <span class="c1"># æ‰“å¼€.pbæ¨¡å‹
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pb_file_path</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">output_graph_def</span><span class="p">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">tensors</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">output_graph_def</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">""</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"tensors:"</span><span class="p">,</span> <span class="n">tensors</span><span class="p">)</span>

        <span class="c1"># åœ¨ä¸€ä¸ªsessionä¸­å»runä¸€ä¸ªå‰å‘
</span>        <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
            <span class="n">init</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">compat</span><span class="p">.</span><span class="n">v1</span><span class="p">.</span><span class="n">global_variables_initializer</span><span class="p">()</span>
            <span class="n">sess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>

            <span class="n">op</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="n">get_operations</span><span class="p">()</span>

            <span class="n">input_x</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s">"conv2d_input:0"</span><span class="p">)</span>  <span class="c1"># å…·ä½“åç§°çœ‹ä¸Šä¸€æ®µä»£ç çš„input.name
</span>            <span class="k">print</span><span class="p">(</span><span class="s">"input_X:"</span><span class="p">,</span> <span class="n">input_x</span><span class="p">)</span>

            <span class="n">out_softmax</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">graph</span><span class="p">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s">"dense/Softmax:0"</span><span class="p">)</span>  <span class="c1"># å…·ä½“åç§°çœ‹ä¸Šä¸€æ®µä»£ç çš„output.name
</span>            <span class="k">print</span><span class="p">(</span><span class="s">"Output:"</span><span class="p">,</span> <span class="n">out_softmax</span><span class="p">)</span>

            <span class="n">img_out_softmax</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">out_softmax</span><span class="p">,</span>
                                       <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="n">input_x</span><span class="p">:</span> <span class="n">img</span><span class="p">})</span>

            <span class="k">return</span> <span class="n">img_out_softmax</span>
</code></pre></div></div>

<h3 id="ä¸‰-c-æ¨¡å‹é¢„æµ‹">ä¸‰. C++ æ¨¡å‹é¢„æµ‹</h3>

<h4 id="31-å°†æ¨¡å‹é¢„æµ‹ç±»è¿›è¡Œå°è£…å¹¶ç”ŸæˆåŠ¨æ€é“¾æ¥åº“dll">3.1 å°†æ¨¡å‹é¢„æµ‹ç±»è¿›è¡Œå°è£…å¹¶ç”ŸæˆåŠ¨æ€é“¾æ¥åº“DLL</h4>

<ul>
  <li>
    <p>VS2019éƒ¨ç½²ï¼ˆå‚è€ƒæœ¬äººçš„ä¸Šä¸€ç¯‡åšå®¢ï¼‰ï¼šæ–°å»ºä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“(DLL)ï¼Œæ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">tf_clf.h</code>å’Œæºæ–‡ä»¶<code class="language-plaintext highlighter-rouge">tf_clf.cpp</code>ï¼Œè¿™é‡Œæ˜¯ç”ŸæˆDLLåŒ…ï¼ˆç‚¹å‡»<code class="language-plaintext highlighter-rouge">ç”Ÿæˆ</code> ==&gt; <code class="language-plaintext highlighter-rouge">é‡æ–°ç”ŸæˆDLLTF</code>ï¼‰</p>
  </li>
  <li>
    <p>è¿™é‡Œè¦æŠŠ<code class="language-plaintext highlighter-rouge">tensorflow_cc.dll</code>æ”¾åˆ°ç”Ÿæˆçš„<code class="language-plaintext highlighter-rouge">x64/release</code>é‡Œé¢</p>
  </li>
  <li>
    <p>è¿™é‡Œè¿˜éœ€è¦åœ¨Releaseå±æ€§é¡µé‡Œé…ç½®<code class="language-plaintext highlighter-rouge">C/C++</code>çš„é¢„å¤„ç†å™¨(é˜²æ­¢åé¢ç¼–è¯‘æ—¶å‡ºç°è¿™ç§é”™è¯¯<code class="language-plaintext highlighter-rouge">tstring.h(350,40): error C2589: â€œ(â€:â€œ::â€</code>)ï¼š</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_XKEYCHECK_H
NOMINMAX
</code></pre></div>    </div>
  </li>
  <li>
    <p>å¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">tf_clf.h</code>ä¸­å£°æ˜ç±»çš„å¯¼å‡º</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#pragma once
#ifndef TF_CLF_H
#endif // !TF_CLF_H


#include &lt;fstream&gt;
#include &lt;utility&gt;
#include &lt;Eigen/Core&gt;
#include &lt;Eigen/Dense&gt;
#include &lt;iostream&gt;

#include "tensorflow/cc/ops/const_op.h"
#include "tensorflow/cc/ops/image_ops.h"
#include "tensorflow/cc/ops/standard_ops.h"

#include "tensorflow/core/framework/graph.pb.h"
#include "tensorflow/core/framework/tensor.h"

#include "tensorflow/core/graph/default_device.h"
#include "tensorflow/core/graph/graph_def_builder.h"

#include "tensorflow/core/lib/core/errors.h"
#include "tensorflow/core/lib/core/stringpiece.h"
#include "tensorflow/core/lib/core/threadpool.h"
#include "tensorflow/core/lib/io/path.h"
#include "tensorflow/core/lib/strings/stringprintf.h"

#include "tensorflow/core/public/session.h"
#include "tensorflow/core/util/command_line_flags.h"

#include "tensorflow/core/platform/env.h"
#include "tensorflow/core/platform/init_main.h"
#include "tensorflow/core/platform/logging.h"
#include "tensorflow/core/platform/types.h"

#include "opencv2/opencv.hpp"

using namespace tensorflow::ops;
using namespace tensorflow;
using namespace std;
using namespace cv;
using tensorflow::Flag;
using tensorflow::Tensor;
using tensorflow::Status;
using tensorflow::string;
using tensorflow::int32;

class __declspec(dllexport) TFClf;
class TFClf {
private:
vector&lt;float&gt; mean = { 103.939,116.779,123.68 };
int resize_col = 224;
int resize_row = 224;
string input_tensor_name = "conv2d_input";
string output_tensor_name = "dense/Softmax";
Point draw_point = Point(50, 50);

public:
string image_path, model_path;
TFClf(string img, string model) :image_path(img), model_path(model) {}
void mat_to_tensor(Mat img, Tensor* output_tensor);
Mat preprocess_img(Mat img);
void model_pred();
void show_result_pic(Mat img, int output_class_id, double output_prob);
};
</code></pre></div></div>

<ul>
  <li>æºæ–‡ä»¶<code class="language-plaintext highlighter-rouge">tf_clf.cpp</code>å®Œæˆç±»çš„å…·ä½“å®ç°ï¼Œæ³¨æ„è¿™é‡Œè¦<code class="language-plaintext highlighter-rouge">#include "pch.h"</code></li>
</ul>

<pre><code class="language-C++">#include "pch.h"
#include "tf_clf.h"


Mat TFClf::preprocess_img(Mat img) {
    //å›¾åƒè¿›è¡Œresizeå¤„ç†
    resize(img, img, cv::Size(resize_col, resize_row));

    //å»å‡å€¼
    img.convertTo(img, CV_32FC3);
    // éå†æ‰€æœ‰çš„åƒç´ çš„æ¯ä¸ªé€šé“ï¼Œå‡å»å¯¹åº”çš„å‡å€¼ï¼ˆBGRè¿™ç§é¡ºåºï¼‰
    for (int row = 0; row &lt; img.rows; row++) {
        for (int col = 0; col &lt; img.cols; col++) {
            img.at&lt;Vec3f&gt;(row, col)[0] -= mean[0];
            img.at&lt;Vec3f&gt;(row, col)[1] -= mean[1];
            img.at&lt;Vec3f&gt;(row, col)[2] -= mean[2];
        }
    }
    return img;
}

void TFClf::mat_to_tensor(Mat img, Tensor* output_tensor) {
    //åˆ›å»ºä¸€ä¸ªæŒ‡å‘tensorçš„å†…å®¹çš„æŒ‡é’ˆ
    float* p = output_tensor-&gt;flat&lt;float&gt;().data();

    //åˆ›å»ºä¸€ä¸ªMatï¼Œä¸tensorçš„æŒ‡é’ˆç»‘å®š,æ”¹å˜è¿™ä¸ªMatçš„å€¼ï¼Œå°±ç›¸å½“äºæ”¹å˜tensorçš„å€¼
    cv::Mat tempMat(resize_row, resize_col, CV_32FC3, p);
    img.convertTo(tempMat, CV_32FC3);
}

void TFClf::show_result_pic(Mat img, int output_class_id,double output_prob) {
    string rs_string;
    if (output_class_id == 0) {
        rs_string = "Class:Dog Proba:" + to_string(output_prob);
    }
    else {
        rs_string = "Class:Cat Proba:" + to_string(output_prob);
    }
    // æŠŠlabelè¾“å‡ºåˆ°å›¾ç‰‡ä¸­
    cv::putText(img, rs_string, draw_point, FONT_HERSHEY_TRIPLEX, 0.8, cv::Scalar(255, 200, 200), 2, CV_AA);
    cv::imshow("result", img);
    cv::waitKey(0);
}

void TFClf::model_pred() {
    /*--------------------------------åˆ›å»ºsession------------------------------*/
    Session* session;
    Status status = NewSession(SessionOptions(), &amp;session);//åˆ›å»ºæ–°ä¼šè¯Session

    /*--------------------------------ä»pbæ–‡ä»¶ä¸­è¯»å–æ¨¡å‹--------------------------------*/
    GraphDef graphdef; //Graph Definition for current model

    Status status_load = ReadBinaryProto(Env::Default(), model_path, &amp;graphdef); //ä»pbæ–‡ä»¶ä¸­è¯»å–å›¾æ¨¡å‹;
    if (!status_load.ok()) {
        std::cout &lt;&lt; "ERROR: Loading model failed..." &lt;&lt; model_path &lt;&lt; std::endl;
        std::cout &lt;&lt; status_load.ToString() &lt;&lt; "\n";
    }
    Status status_create = session-&gt;Create(graphdef); //å°†æ¨¡å‹å¯¼å…¥ä¼šè¯Sessionä¸­;
    if (!status_create.ok()) {
        std::cout &lt;&lt; "ERROR: Creating graph in session failed..." &lt;&lt; status_create.ToString() &lt;&lt; std::endl;
    }
    std::cout &lt;&lt; "&lt;----Successfully created session and load graph.-------&gt;" &lt;&lt; endl;

    /*---------------------------------è½½å…¥æµ‹è¯•å›¾ç‰‡-------------------------------------*/
    std::cout &lt;&lt; endl &lt;&lt; "&lt;------------loading test_image--------------&gt;" &lt;&lt; endl;
    Mat img = imread(image_path);


    if (img.empty())
    {
        std::cout &lt;&lt; "can't open the image!!!!!!!" &lt;&lt; endl;
    }
    // å›¾åƒé¢„å¤„ç†
    Mat resize_img;
    resize_img = preprocess_img(img);
    //åˆ›å»ºä¸€ä¸ªtensorä½œä¸ºè¾“å…¥ç½‘ç»œçš„æ¥å£
    Tensor resized_tensor(DT_FLOAT, TensorShape({ 1,resize_row,resize_col,3 }));

    //å°†Opencvçš„Matæ ¼å¼çš„å›¾ç‰‡å­˜å…¥tensor
    mat_to_tensor(resize_img, &amp;resized_tensor);

    /*-----------------------------------ç”¨ç½‘ç»œè¿›è¡Œæµ‹è¯•-----------------------------------------*/
    std::cout &lt;&lt; endl &lt;&lt; "&lt;-------------Running the model with test_image---------------&gt;" &lt;&lt; endl;
    //å‰å‘è¿è¡Œï¼Œè¾“å‡ºç»“æœä¸€å®šæ˜¯ä¸€ä¸ªtensorçš„vector
    vector&lt;tensorflow::Tensor&gt; outputs;
    string output_node = output_tensor_name;
    Status status_run = session-&gt;Run({ {input_tensor_name, resized_tensor} }, { output_node }, {}, &amp;outputs);

    if (!status_run.ok()) {
        std::cout &lt;&lt; "ERROR: RUN failed..." &lt;&lt; std::endl;
        std::cout &lt;&lt; status_run.ToString() &lt;&lt; "\n";
    }
    //æŠŠè¾“å‡ºå€¼ç»™æå–å‡ºæ¥
    Tensor t = outputs[0];                   // Fetch the first tensor
    auto tmap = t.tensor&lt;float, 2&gt;();        // Tensor Shape: [batch_size, target_class_num]
    int output_dim = t.shape().dim_size(1);  // Get the target_class_num from 1st dimension
    // Argmax: Get Final Prediction Label and Probability
    int output_class_id = -1;
    double output_prob = 0.0;
    for (int j = 0; j &lt; output_dim; j++)
    {
        std::cout &lt;&lt; "Class " &lt;&lt; j &lt;&lt; " prob:" &lt;&lt; tmap(0, j) &lt;&lt; "," &lt;&lt; std::endl;
        if (tmap(0, j) &gt;= output_prob) {
            output_class_id = j;
            output_prob = tmap(0, j);
        }
    }
    // å±•ç¤ºå›¾ç‰‡ç»“æœ
    show_result_pic(img, output_class_id, output_prob);

}
</code></pre>

<h4 id="32-æ–°å»ºä¸€ä¸ªé¡¹ç›®æµ‹è¯•dll">3.2 æ–°å»ºä¸€ä¸ªé¡¹ç›®æµ‹è¯•DLL</h4>

<ul>
  <li>
    <p>æ–°å»ºä¸€ä¸ªæ§åˆ¶å°çš„ç©ºé¡¹ç›®ï¼Œå¹¶å°†æ‰“åŒ…å¥½çš„<code class="language-plaintext highlighter-rouge">DllTF.dll</code>å’Œ<code class="language-plaintext highlighter-rouge">DllTF.lib</code>å¤åˆ¶åˆ°å·¥ç¨‹ä¸­</p>
  </li>
  <li>
    <p>é…ç½®å±æ€§ç®¡ç†å™¨ï¼šè¿™é‡Œéœ€è¦åœ¨<code class="language-plaintext highlighter-rouge">Release | x64</code>æ·»åŠ ä¹‹å‰é…ç½®å¥½çš„<code class="language-plaintext highlighter-rouge">opencv_release.props</code>å’Œ<code class="language-plaintext highlighter-rouge">tf_release.props</code>ã€‚</p>
  </li>
  <li>
    <p>è¿™é‡Œè¦æŠŠ<code class="language-plaintext highlighter-rouge">tensorflow_cc.dll</code>æ”¾åˆ°ç”Ÿæˆçš„<code class="language-plaintext highlighter-rouge">x64/release</code>é‡Œé¢</p>
  </li>
  <li>
    <p>æ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">tf_clf.h</code></p>
  </li>
</ul>

<pre><code class="language-C++">#pragma once
#ifndef TF_CLF_H

#endif // !TF_CLF_H

#pragma comment(lib,"DllTF.lib")
class __declspec(dllexport) TFClf;

#include &lt;fstream&gt;
#include &lt;utility&gt;
#include &lt;Eigen/Core&gt;
#include &lt;Eigen/Dense&gt;
#include &lt;iostream&gt;

#include "tensorflow/cc/ops/const_op.h"
#include "tensorflow/cc/ops/image_ops.h"
#include "tensorflow/cc/ops/standard_ops.h"

#include "tensorflow/core/framework/graph.pb.h"
#include "tensorflow/core/framework/tensor.h"

#include "tensorflow/core/graph/default_device.h"
#include "tensorflow/core/graph/graph_def_builder.h"

#include "tensorflow/core/lib/core/errors.h"
#include "tensorflow/core/lib/core/stringpiece.h"
#include "tensorflow/core/lib/core/threadpool.h"
#include "tensorflow/core/lib/io/path.h"
#include "tensorflow/core/lib/strings/stringprintf.h"

#include "tensorflow/core/public/session.h"
#include "tensorflow/core/util/command_line_flags.h"

#include "tensorflow/core/platform/env.h"
#include "tensorflow/core/platform/init_main.h"
#include "tensorflow/core/platform/logging.h"
#include "tensorflow/core/platform/types.h"

#include "opencv2/opencv.hpp"

using namespace tensorflow::ops;
using namespace tensorflow;
using namespace std;
using namespace cv;
using tensorflow::Flag;
using tensorflow::Tensor;
using tensorflow::Status;
using tensorflow::string;
using tensorflow::int32;



class TFClf {
private:
    vector&lt;float&gt; mean = { 103.939,116.779,123.68 };
    int resize_col = 224;
    int resize_row = 224;
    string input_tensor_name = "conv2d_input";
    string output_tensor_name = "dense/Softmax";
    Point draw_point = Point(50, 50);

public:
    string image_path, model_path;
    TFClf(string img, string model) :image_path(img), model_path(model) {}
    void mat_to_tensor(Mat img, Tensor* output_tensor);
    Mat preprocess_img(Mat img);
    void model_pred();
    void show_result_pic(Mat img, int output_class_id, double output_prob);
};
</code></pre>

<ul>
  <li>æ–°å»ºä¸€ä¸ªæºæ–‡ä»¶<code class="language-plaintext highlighter-rouge">main.cpp</code></li>
</ul>

<pre><code class="language-C++"># include "tf_clf.h"

int main() {
string model_path = "D:/yeyan/pycharm_project/dogcat/model/model.pt";
string img_path = "D:/yeyan/pycharm_project/dogcat/data/test_set/test_set/cats/cat.4001.jpg";
TFClf clf = TFClf(img_path, model_path);
clf.model_pred();
}
</code></pre>

:ET